<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Galerie des observations</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <style>
      body {
        background: #0d1117;
        color: #e6edf3;
      }
      header {
        margin-bottom: 1.5rem;
      }
      .species-grid {
        display: grid;
        gap: 1.2rem;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      }
      .card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0.8rem 0.9rem;
        display: flex;
        flex-direction: column;
      }
      .thumb {
        aspect-ratio: 4/3;
        object-fit: cover;
        width: 100%;
        border-radius: 6px;
        background: #000;
        border: 1px solid #30363d;
      }
      details summary {
        cursor: pointer;
      }
      .badge {
        background: #238636;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
        margin-left: 0.4rem;
      }
      a.video-link {
        font-size: 0.85rem;
        word-break: break-all;
      }
      .no-img {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: #8b949e;
        border: 1px dashed #30363d;
        height: 100%;
        border-radius: 6px;
      }
      footer {
        margin-top: 2rem;
        font-size: 0.75rem;
        color: #6e7681;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>Observations ({{ total }})</h1>
        <p>
          Galerie groupée par espèce. Cliquez pour voir les vidéos récentes.
          <a href="/api/live/">Flux temps réel</a>
        </p>
        <form
          method="get"
          style="
            display: grid;
            gap: 0.6rem;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            align-items: end;
          "
        >
          <div>
            <label
              >Espèce exacte
              <input
                type="text"
                name="species"
                value="{{ species_exact }}"
                placeholder="cardinal"
              />
            </label>
          </div>
          <div>
            <label
              >Recherche
              <input
                type="text"
                name="q"
                value="{{ q_term }}"
                placeholder="contient..."
              />
            </label>
          </div>
          <div>
            <label
              >Début
              <input type="date" name="start" value="{{ start_str }}" />
            </label>
          </div>
          <div>
            <label
              >Fin
              <input type="date" name="end" value="{{ end_str }}" />
            </label>
          </div>
          <div>
            <label
              >Par page
              <input
                type="number"
                name="per"
                min="1"
                max="100"
                value="{{ per }}"
              />
            </label>
          </div>
          <div style="display: flex; gap: 0.5rem">
            <button type="submit">Filtrer</button>
            <a href="?" role="button" class="secondary">Réinitialiser</a>
          </div>
        </form>
        <p style="margin-top: 0.5rem; font-size: 0.8rem; color: #8b949e">
          Espèces: {{ total_species }} | Page {{ page }} / {{ total_pages }}
        </p>
      </header>
      {% if species_groups %}
      <div class="species-grid">
        {% for g in species_groups %}
        <article class="card">
          {% if g.representative and g.representative.frame_image %}
          <img
            class="thumb"
            src="{{ g.representative.frame_image.url }}"
            alt="{{ g.species }}"
          />
          {% else %}
          <div class="thumb no-img">(pas d'image)</div>
          {% endif %}
          <h3 style="margin: 0.6rem 0 0.3rem 0">
            {{ g.species }} <span class="badge">{{ g.count }}</span>
          </h3>
          <details>
            <summary>Vidéos</summary>
            <ul>
              {% for o in g.observations %}
              <li>
                <a
                  class="video-link"
                  href="{{ o.video_file.url }}"
                  target="_blank"
                  rel="noopener"
                >
                  {{ o.created_at|date:"Y-m-d H:i:s" }} ({{
                  o.confidence|default:"?" }})
                </a>
                {% if o.frame_image %} –
                <a
                  class="video-link"
                  href="{{ o.frame_image.url }}"
                  target="_blank"
                  >frame</a
                >
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </details>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p>Aucune observation pour le moment.</p>
      {% endif %}
      <nav
        style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap"
      >
        {% if has_prev %}
        <a
          role="button"
          href="?page=1{% if query_no_page %}&{{ query_no_page }}{% endif %}"
          >« Première</a
        >
        <a
          role="button"
          href="?page={{ prev_page }}{% if query_no_page %}&{{ query_no_page }}{% endif %}"
          >‹ Précédente</a
        >
        {% else %}
        <span role="button" aria-disabled="true" class="secondary"
          >« Première</span
        >
        <span role="button" aria-disabled="true" class="secondary"
          >‹ Précédente</span
        >
        {% endif %}
        <span style="align-self: center"
          >Page {{ page }} / {{ total_pages }}</span
        >
        {% if has_next %}
        <a
          role="button"
          href="?page={{ next_page }}{% if query_no_page %}&{{ query_no_page }}{% endif %}"
          >Suivante ›</a
        >
        <a
          role="button"
          href="?page={{ total_pages }}{% if query_no_page %}&{{ query_no_page }}{% endif %}"
          >Dernière »</a
        >
        {% else %}
        <span role="button" aria-disabled="true" class="secondary"
          >Suivante ›</span
        >
        <span role="button" aria-disabled="true" class="secondary"
          >Dernière »</span
        >
        {% endif %}
      </nav>
      <footer style="margin-top: 1rem">
        Généré automatiquement. Actualiser pour voir de nouvelles captures.
      </footer>
    </main>
  </body>
</html>
